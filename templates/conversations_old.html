{% extends "base.html" %}

{% block title %}Conversations - ChatGPT Search{% endblock %}

{% block page_title %}Conversations{% endblock %}

{% block page_styles %}
    .conversation-card {
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eaeaea;
    }

    .conversation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f9f9f9;
        border-bottom: 1px solid #eee;
    }

    .conversation-title {
        margin: 0;
        font-size: 1.1rem;
        color: #333;
        font-weight: 500;
    }

    .conversation-date {
        font-size: 0.85rem;
        color: #6c757d;
        background-color: #f1f1f1;
        padding: 2px 8px;
        border-radius: 12px;
    }

    .conversation-preview {
        padding: 1rem;
        background-color: white;
        color: #555;
        max-height: 100px;
        overflow: hidden;
        position: relative;
    }

    .conversation-preview::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40px;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
    }

    .conversation-footer {
        padding: 0.75rem 1rem;
        background-color: #f8f9fa;
        border-top: 1px solid #eee;
        text-align: right;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .filters {
        padding: 1rem;
        margin-bottom: 1.5rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .page-navigation {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    .date-header {
        margin: 1.5rem 0 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ddd;
        color: #495057;
    }
    
    /* Export button styles */
    .export-btn {
        min-width: 80px;
    }
    
    /* Notification styles */
    #exportNotification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        color: white;
        border-radius: 4px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .conversation-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        .conversation-title {
            font-size: 1rem;
        }
        .conversation-date {
            align-self: stretch;
            text-align: center;
        }
        .conversation-preview {
            padding: 0.75rem;
            max-height: 80px;
            font-size: 0.9rem;
        }
        .conversation-preview::after {
            height: 30px;
        }
        .conversation-footer {
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .conversation-footer .btn {
            margin-top: 5px;
        }
        .filters {
            padding: 0.75rem;
        }
        .row.g-3 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }
        .col-md-4, .col-md-8 {
            flex: 0 0 auto;
            width: 100%;
        }
        .empty-state {
            padding: 2rem 1rem;
        }
        .empty-state-icon {
            font-size: 2rem;
        }
        /* Fix for search form */
        .search-section .row.g-3 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }
        .search-section .col-md-8, 
        .search-section .col-md-4 {
            flex: 0 0 auto;
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .conversation-preview {
            max-height: 100px;
        }
        .conversation-preview::after {
            height: 40px;
        }
        .page-navigation .pagination .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    }
{% endblock %}

{% block content %}
<!-- Search Form -->
<div class="search-section mb-4">
    <form method="POST" action="/conversations" class="mb-3">
        {{ search_form.hidden_tag() }}
        <div class="row g-3">
            <div class="col-md-8">
                <div class="input-group">
                    {{ search_form.query(class="form-control", placeholder="Search conversations...") }}
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-floating">
                    {{ search_form.search_type(class="form-select") }}
                    <label for="{{ search_form.search_type.id }}">Search Method</label>
                </div>
            </div>
        </div>
    </form>
    
    {% if search_triggered %}
        <div class="alert alert-info">
            <strong>{{ search_form.search_type.data|title }} Search Results for:</strong> "{{ query }}"
            <a href="/conversations" class="btn btn-sm btn-outline-secondary ms-2">Clear Search</a>
        </div>
    {% endif %}
</div>

<div class="filters">
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Source</label>
            <select class="form-select" id="sourceFilter">
                <option value="all" {% if source_filter == 'all' %}selected{% endif %}>All Sources</option>
                <option value="chatgpt" {% if source_filter == 'chatgpt' %}selected{% endif %}>ChatGPT</option>
                <option value="claude" {% if source_filter == 'claude' %}selected{% endif %}>Claude</option>
                <option value="docx" {% if source_filter == 'docx' %}selected{% endif %}>Word Documents</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Date Range</label>
            <select class="form-select" id="dateFilter">
                <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
                <option value="week" {% if date_filter == 'week' %}selected{% endif %}>Past Week</option>
                <option value="month" {% if date_filter == 'month' %}selected{% endif %}>Past Month</option>
                <option value="year" {% if date_filter == 'year' %}selected{% endif %}>Past Year</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Sort Order</label>
            <select class="form-select" id="sortOrder">
                <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Newest First</option>
                <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Oldest First</option>
                <option value="original" {% if sort_order == 'original' %}selected{% endif %}>Original Order</option>
            </select>
        </div>
    </div>
</div>

{% if conversations %}
    <div id="conversationList">
        {% for conversation in conversations %}
            <div class="conversation-card" data-source="{{ conversation.meta.source }}" data-date="{{ conversation.meta.latest_ts }}">
                <div class="conversation-header">
                    <h5 class="conversation-title">{{ conversation.meta.title }}</h5>
                    <span class="conversation-date date-to-format">{{ conversation.meta.latest_ts }}</span>
                </div>
                <div class="conversation-preview">
                    {{ conversation.preview|safe }}
                </div>
                <div class="conversation-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary">{{ 'ChatGPT' if conversation.meta.source|lower == 'chatgpt' else conversation.meta.source|capitalize }}</span>
                            {% if conversation.meta.relevance_display and conversation.meta.relevance_display != 'N/A' %}
                                <span class="badge bg-info ms-2">Score: {{ conversation.meta.relevance_display }}</span>
                            {% endif %}
                        </div>
                        <div>
                            <a href="/view/{{ conversation.id }}" class="btn btn-sm btn-outline-primary">View</a>
                            <button type="button" class="btn btn-sm btn-outline-success export-btn ms-1" data-conversation-id="{{ conversation.id }}" onclick="exportToOpenWebUI('{{ conversation.id }}', this); return false;">
                                <span class="button-text">Export</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    {% if page_count > 1 %}
        <div class="page-navigation">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}"><a class="page-link" href="{{ url_for('conversations', page=current_page-1, source=source_filter, date=date_filter, sort=sort_order) }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
                    {% if current_page > 3 %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('conversations', page=1, source=source_filter, date=date_filter, sort=sort_order) }}">1</a></li>
                        {% if current_page > 4 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                    {% endif %}
                    {% set start_page = current_page - 2 if current_page - 2 > 0 else 1 %}
                    {% set end_page = current_page + 2 if current_page + 2 < page_count else page_count %}
                    {% for p in range(start_page, end_page + 1) %}
                        <li class="page-item {% if p == current_page %}active{% endif %}"><a class="page-link" href="{{ url_for('conversations', page=p, source=source_filter, date=date_filter, sort=sort_order) }}">{{ p }}</a></li>
                    {% endfor %}
                    {% if current_page < page_count - 2 %}
                        {% if current_page < page_count - 3 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('conversations', page=page_count, source=source_filter, date=date_filter, sort=sort_order) }}">{{ page_count }}</a></li>
                    {% endif %}
                    <li class="page-item {% if current_page == page_count %}disabled{% endif %}"><a class="page-link" href="{{ url_for('conversations', page=current_page+1, source=source_filter, date=date_filter, sort=sort_order) }}" aria-label="Next">&raquo;</a></li>
                </ul>
            </nav>
        </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ’¬</div>
        <h3>No Conversations Found</h3>
        <p>Upload some ChatGPT conversations to get started.</p>
        <a href="/upload" class="btn btn-primary mt-3">Upload Conversations</a>
    </div>
{% endif %}
{% endblock %}

{% block page_scripts %}
<script>
    // Clean, composable filter management
    class ConversationFilters {
        constructor() {
            this.sourceFilter = document.getElementById('sourceFilter');
            this.dateFilter = document.getElementById('dateFilter');
            this.sortOrder = document.getElementById('sortOrder');
            this.init();
        }

        init() {
            this.readUrlParams();
            this.setupEventListeners();
            this.formatDates();
        }

        // Read URL parameters and set filter values
        readUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            const source = params.get('source');
            const date = params.get('date');
            const sort = params.get('sort');
            
            if (source && this.sourceFilter) {
                this.sourceFilter.value = source;
            }
            if (date && this.dateFilter) {
                this.dateFilter.value = date;
            }
            if (sort && this.sortOrder) {
                this.sortOrder.value = sort;
            }
        }

        // Setup event listeners for filter changes
        setupEventListeners() {
            const filters = [this.sourceFilter, this.dateFilter, this.sortOrder];
            
            filters.forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', () => {
                        this.applyFilters();
                    });
                }
            });
        }

        // Get current filter values
        getCurrentFilters() {
            return {
                source: this.sourceFilter?.value || 'all',
                date: this.dateFilter?.value || 'all',
                sort: this.sortOrder?.value || 'newest'
            };
        }

        // Build URL with current filter values
        buildFilterUrl() {
            const filters = this.getCurrentFilters();
            const params = new URLSearchParams();
            
            if (filters.source !== 'all') {
                params.set('source', filters.source);
            }
            if (filters.date !== 'all') {
                params.set('date', filters.date);
            }
            if (filters.sort !== 'newest') {
                params.set('sort', filters.sort);
            }
            
            const queryString = params.toString();
            return window.location.pathname + (queryString ? '?' + queryString : '');
        }

        // Apply filters by navigating to new URL
        applyFilters() {
            const newUrl = this.buildFilterUrl();
            
            // Navigate to the filtered URL
            window.location.href = newUrl;
        }

        // Format date elements for display
        formatDates() {
            const dateElements = document.querySelectorAll('.date-to-format');
            
            dateElements.forEach(element => {
                const dateStr = element.textContent.trim();
                
                if (dateStr && dateStr !== 'Unknown date') {
                    try {
                        const date = new Date(dateStr);
                        
                        if (!isNaN(date.getTime())) {
                            const options = {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            };
                            
                            element.textContent = date.toLocaleDateString(undefined, options);
                        }
                    } catch (e) {
                        // Keep original text if parsing fails
                        console.warn('Date parsing failed for:', dateStr, e);
                    }
                }
            });
        }
    }

    // Initialize filters when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        new ConversationFilters();
    });
    
    // Export to OpenWebUI function
    async function exportToOpenWebUI(conversationId, button) {
        const buttonText = button.querySelector('.button-text');
        const spinner = button.querySelector('.spinner-border');
        
        // Store original button text to restore later
        const originalText = buttonText.textContent;
        
        // Disable button and show spinner
        button.disabled = true;
        buttonText.textContent = 'Exporting...';
        spinner.classList.remove('d-none');
        
        try {
            const response = await fetch(`/export_to_openwebui/${conversationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();

            if (response.ok && data.success) {
                // Copy URL to clipboard if available
                if (data.url) {
                    try {
                        await navigator.clipboard.writeText(data.url);
                        showNotification('Exported to OpenWebUI! URL copied to clipboard.', 'success');
                    } catch (err) {
                        showNotification('Successfully exported to OpenWebUI!', 'success');
                        console.error('Failed to copy URL to clipboard:', err);
                    }

                    // Open URL in default browser
                    window.open(data.url, '_blank');
                } else {
                    showNotification('Successfully exported to OpenWebUI!', 'success');
                }

                buttonText.textContent = 'Exported!';

                // Reset button after 2 seconds
                setTimeout(() => {
                    button.disabled = false;
                    buttonText.textContent = originalText;
                    spinner.classList.add('d-none');
                }, 2000);
            } else {
                // Show error message
                const errorMsg = data.error || 'Failed to export to OpenWebUI';
                showNotification(errorMsg, 'error');
                buttonText.textContent = 'Export Failed';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    buttonText.textContent = originalText;
                    spinner.classList.add('d-none');
                }, 3000);
            }
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Network error: Could not connect to server', 'error');
            buttonText.textContent = 'Export Failed';
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                buttonText.textContent = originalText;
                spinner.classList.add('d-none');
            }, 3000);
        }
    }
    
    // Helper function to show notifications
    function showNotification(message, type = 'success') {
        // Create notification element if it doesn't exist
        let notification = document.getElementById('exportNotification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'exportNotification';
            notification.style.cssText = `
                display: none;
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                color: white;
                border-radius: 4px;
                z-index: 1000;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(notification);
        }
        
        // Set message and type
        notification.textContent = message;
        notification.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
        notification.style.display = 'block';
        
        // Hide after 5 seconds
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}
