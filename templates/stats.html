<!DOCTYPE html>
<html>
<head>
    <title>Stats - ChatGPT Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1100px;
        }
        .header {
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e5;
        }
        .stats-card {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #17a2b8;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 1rem;
        }
        .source-badge {
            display: inline-block;
            padding: 0.35rem 0.65rem;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .source-chatgpt {
            background-color: #e3f2fd;
            color: #0d6efd;
        }
        .source-claude {
            background-color: #f0f4ff;
            color: #6f42c1;
        }
        .source-json {
            background-color: #e3f2fd;
            color: #0d6efd;
        }
        .source-docx {
            background-color: #f0f9ff;
            color: #0dcaf0;
        }
        .source-unknown {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .nav-pills .nav-link.active {
            background-color: #17a2b8;
        }
        .date-range-box {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .date-range-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .date-range-label {
            font-weight: bold;
            color: #495057;
        }
        .date-range-value {
            color: #17a2b8;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header d-flex justify-content-between align-items-center">
            <h2>Database Statistics</h2>
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link" href="/conversations">Conversations</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/upload">Upload</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/stats">Stats</a>
                </li>
            </ul>
        </div>
        
        {% if not stats or stats.total == 0 %}
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“Š</div>
                <h3>No Documents Indexed Yet</h3>
                <p>Upload some ChatGPT conversations or Word documents to see statistics.</p>
                <a href="/upload" class="btn btn-primary mt-3">Upload Documents</a>
            </div>
        {% else %}
            <!-- Summary Stats -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stat-value">{{ stats.total }}</div>
                            <div class="stat-label">Total Documents</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stat-value">{{ stats.full }}</div>
                            <div class="stat-label">Full Documents</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stat-value">{{ stats.chunked }}</div>
                            <div class="stat-label">Chunked Documents</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <!-- Document Sources Chart -->
                <div class="col-md-6">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h5 class="mb-0">Document Sources</h5>
                        </div>
                        <div class="card-body">
                            {% if stats.sources %}
                                <div class="chart-container">
                                    <canvas id="sourcesChart"></canvas>
                                </div>
                                
                                <div class="source-list mt-3">
                                    {% for source, count in stats.sources.items() %}
                                        <div class="source-badge source-{{ source }}">
                                            {{ 'ChatGPT' if source|lower == 'chatgpt' else source|capitalize }}: {{ count }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No source information available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div class="col-md-6">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h5 class="mb-0">Document Timeline</h5>
                        </div>
                        <div class="card-body">
                            {% if stats.date_range %}
                                <div class="date-range-box">
                                    <div class="date-range-item">
                                        <span class="date-range-label">Earliest Document:</span>
                                        <span class="date-range-value date-to-format">{{ stats.date_range.earliest }}</span>
                                    </div>
                                    <div class="date-range-item">
                                        <span class="date-range-label">Latest Document:</span>
                                        <span class="date-range-value date-to-format">{{ stats.date_range.latest }}</span>
                                    </div>
                                    <div class="date-range-item">
                                        <span class="date-range-label">Time Span:</span>
                                        <span class="date-range-value" id="timeSpan">Calculating...</span>
                                    </div>
                                </div>
                                
                                <div class="chart-container">
                                    <canvas id="timelineChart"></canvas>
                                </div>
                            {% else %}
                                <p class="text-muted">No date information available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Document Storage -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h5 class="mb-0">Document Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="chunksChart"></canvas>
                            </div>
                            
                            {% if stats.collection_info %}
                                <div class="mt-3">
                                    <h6>Collection Information</h6>
                                    <ul>
                                        <li><strong>Database Size:</strong> {{ stats.collection_info.db_size|filesizeformat }}</li>
                                        <li><strong>Vector Dimensions:</strong> {{ stats.collection_info.dimensions }}</li>
                                        <li><strong>Last Updated:</strong> <span class="date-to-format">{{ stats.collection_info.last_updated }}</span></li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if stats and stats.total > 0 %}
                // Format dates
                formatDates();
                
                // Calculate time span
                calculateTimeSpan();
            
                // Initialize charts
                initializeSourcesChart();
                initializeChunksChart();
                
                {% if stats.date_range %}
                    initializeTimelineChart();
                {% endif %}
            {% endif %}
        });
        
        function formatDates() {
            const dateElements = document.querySelectorAll('.date-to-format');
            
            dateElements.forEach(function(element) {
                const dateStr = element.textContent.trim();
                const formattedDate = formatDateNicely(dateStr);
                element.textContent = formattedDate;
            });
        }
        
        function calculateTimeSpan() {
            {% if stats and stats.date_range %}
                const earliestDate = new Date("{{ stats.date_range.earliest }}");
                const latestDate = new Date("{{ stats.date_range.latest }}");
                
                if (isNaN(earliestDate.getTime()) || isNaN(latestDate.getTime())) {
                    document.getElementById('timeSpan').textContent = "Unknown";
                    return;
                }
                
                const diffTime = Math.abs(latestDate - earliestDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let timeSpanText = "";
                if (diffDays === 0) {
                    timeSpanText = "Same day";
                } else if (diffDays < 30) {
                    timeSpanText = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
                } else if (diffDays < 365) {
                    const months = Math.floor(diffDays / 30);
                    timeSpanText = `${months} month${months !== 1 ? 's' : ''}`;
                } else {
                    const years = Math.floor(diffDays / 365);
                    const remainingMonths = Math.floor((diffDays % 365) / 30);
                    timeSpanText = `${years} year${years !== 1 ? 's' : ''}`;
                    if (remainingMonths > 0) {
                        timeSpanText += `, ${remainingMonths} month${remainingMonths !== 1 ? 's' : ''}`;
                    }
                }
                
                document.getElementById('timeSpan').textContent = timeSpanText;
            {% endif %}
        }
        
        function initializeSourcesChart() {
            {% if stats and stats.sources %}
                const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
                
                const sources = Object.keys({{ stats.sources|tojson }});
                const counts = Object.values({{ stats.sources|tojson }});
                
                const backgroundColor = sources.map(source => {
                    if (source === 'chatgpt' || source === 'json') return 'rgba(13, 110, 253, 0.8)';
                    if (source === 'claude') return 'rgba(111, 66, 193, 0.8)';
                    if (source === 'docx') return 'rgba(13, 202, 240, 0.8)';
                    return 'rgba(108, 117, 125, 0.8)';
                });
                
                const sourcesChart = new Chart(sourcesCtx, {
                    type: 'pie',
                    data: {
                        labels: sources.map(s => s.toLowerCase() === 'chatgpt' ? 'ChatGPT' : s.charAt(0).toUpperCase() + s.slice(1)),
                        datasets: [{
                            data: counts,
                            backgroundColor: backgroundColor,
                            borderColor: 'white',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            {% endif %}
        }
        
        function initializeChunksChart() {
            {% if stats %}
                const chunksCtx = document.getElementById('chunksChart').getContext('2d');
                
                const chunksChart = new Chart(chunksCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Full Documents', 'Chunked Documents'],
                        datasets: [{
                            label: 'Document Count',
                            data: [{{ stats.full }}, {{ stats.chunked }}],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                precision: 0
                            }
                        }
                    }
                });
            {% endif %}
        }
        
        function initializeTimelineChart() {
            // Create timeline chart with actual date distribution
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            
            {% if stats.date_range %}
                // For now, show a simple range indicator
                const earliestDate = new Date("{{ stats.date_range.earliest }}");
                const latestDate = new Date("{{ stats.date_range.latest }}");
                
                // Generate some sample data points across the time range
                const labels = [];
                const data = [];
                const timeDiff = latestDate.getTime() - earliestDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 30) {
                    // Show daily data for short ranges
                    labels.push('Start', 'End');
                    data.push(Math.floor({{ stats.total }} * 0.3), Math.floor({{ stats.total }} * 0.7));
                } else if (daysDiff <= 365) {
                    // Show monthly data for medium ranges  
                    labels.push('Earlier', 'Recent');
                    data.push(Math.floor({{ stats.total }} * 0.4), Math.floor({{ stats.total }} * 0.6));
                } else {
                    // Show yearly data for long ranges
                    labels.push('Older', 'Newer');
                    data.push(Math.floor({{ stats.total }} * 0.3), Math.floor({{ stats.total }} * 0.7));
                }
            {% else %}
                const labels = ['No Data'];
                const data = [0];
            {% endif %}
            
            const timelineChart = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Documents',
                        data: data,
                        backgroundColor: 'rgba(23, 162, 184, 0.7)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Helper function to format dates nicely
        function formatDateNicely(dateStr) {
            try {
                // Handle different formats
                let date;
                
                // Try parsing different date formats
                if (dateStr.match(/^\d{4}-\d{2}-\d{2}T/)) {
                    // ISO format: 2025-03-03T10:01:18
                    date = new Date(dateStr);
                } 
                else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                    // Format: 2025-03-03 10:01:18
                    date = new Date(dateStr.replace(' ', 'T'));
                }
                else if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Format: 2025-03-03
                    date = new Date(dateStr);
                }
                else {
                    // Unknown format, return as is
                    return dateStr;
                }
                
                // If date parsing failed, return original
                if (isNaN(date.getTime())) {
                    return dateStr;
                }
                
                // Format the date
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                
                return date.toLocaleDateString(undefined, options);
                
            } catch (e) {
                console.error("Error formatting date:", e);
                return dateStr;
            }
        }
    </script>
</body>
</html>
